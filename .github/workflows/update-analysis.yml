name: Update Analysis Data

on:
  # Manual trigger
  workflow_dispatch:

  # Weekly schedule (Sundays at 2am UTC)
  schedule:
    - cron: '0 2 * * 0'

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.14
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install polars==1.38.0 \
                      beautifulsoup4==4.12.2 \
                      jinja2==3.1.2 \
                      duckdb==1.1.3 \
                      playwright==1.50.0 \
                      lxml==5.3.0

      - name: Install Playwright browsers
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Run Super Bowl scraper
        run: |
          python -c "from scrapers.superbowl_history import scrape_superbowl_history; scrape_superbowl_history()"
        continue-on-error: true

      - name: Run playoff scraper
        run: |
          python -c "from scrapers.playoff_history import scrape_playoff_history; scrape_playoff_history(seasons=list(range(2020, 2025)))"
        continue-on-error: true

      - name: Run player stats scraper
        run: |
          python -c "from scrapers.player_stats import scrape_player_stats; scrape_player_stats(season=2024)"
        continue-on-error: true

      - name: Generate static site
        run: |
          python generate_site.py

      - name: Commit and push if changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add data files and static site
          git add data/*.parquet static_site/

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update analysis data and regenerate site

            Automated update from GitHub Actions
            - Scraped latest Super Bowl data
            - Scraped playoff data (2020-2024)
            - Scraped player stats (2024 season)
            - Regenerated static site

            [skip ci]"
            git push
          fi
