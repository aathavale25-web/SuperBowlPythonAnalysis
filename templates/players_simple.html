{% extends "base.html" %}
{% set page = 'players' %}

{% block content %}
<h1>Player Props Analysis</h1>
<p class="subtitle">2025 Season Performance - Both Teams</p>

<!-- Position Filters -->
<div class="filter-buttons">
    <button class="filter-btn active" onclick="filterByPosition('all')">All Players</button>
    <button class="filter-btn" onclick="filterByPosition('QB')">QB</button>
    <button class="filter-btn" onclick="filterByPosition('RB')">RB</button>
    <button class="filter-btn" onclick="filterByPosition('WR')">WR</button>
    <button class="filter-btn" onclick="filterByPosition('TE')">TE</button>
</div>

<style>
    .filter-buttons {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    .filter-btn {
        padding: 10px 20px;
        background: white;
        border: 2px solid #002244;
        color: #002244;
        font-weight: bold;
        cursor: pointer;
        border-radius: 5px;
        transition: all 0.3s;
    }
    .filter-btn:hover {
        background: #f0f0f0;
    }
    .filter-btn.active {
        background: #002244;
        color: white;
    }
    .player-name { color: #0066cc; cursor: pointer; text-decoration: underline; }
    .player-name:hover { color: #004499; }
    .game-details { display: none; margin: 20px 0; padding: 20px; background: #f8f9fa; border-left: 4px solid #002244; }
    .game-details.show { display: block; }
    .game-details table { margin: 10px 0; }
    .game-details th { background-color: #69BE28; }
    .close-btn { float: right; cursor: pointer; color: #666; font-weight: bold; font-size: 1.5em; }
    .close-btn:hover { color: #000; }
    .stat-card { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .stat-card.hidden { display: none; }
    .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
    .stat-label { font-weight: bold; color: #666; }
    .stat-value { color: #002244; font-weight: bold; }
</style>

<script>
    function toggleGameDetails(playerName) {
        const detailsId = 'details-' + playerName.replace(/\s+/g, '-');
        const details = document.getElementById(detailsId);
        if (details) {
            details.classList.toggle('show');
        }
    }

    function filterByPosition(position) {
        // Update button states
        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // Filter player cards
        const cards = document.querySelectorAll('.stat-card[data-position]');
        cards.forEach(card => {
            if (position === 'all' || card.dataset.position === position) {
                card.classList.remove('hidden');
            } else {
                card.classList.add('hidden');
            }
        });
    }
</script>

{% for player in data.players.summaries %}
<div class="stat-card" data-position="{{ player.position }}">
    <h2>
        <span class="player-name" onclick="toggleGameDetails('{{ player.name }}')">
            {{ player.name }}
        </span>
        <span style="color: #666; font-size: 0.8em; font-weight: normal;">
            {{ player.position }} - {{ player.team }}
        </span>
    </h2>

    <div class="stat-row">
        <span class="stat-label">Games Played:</span>
        <span class="stat-value">{{ player.games_played }}</span>
    </div>

    <!-- Super Bowl Projection -->
    <div class="stat-row" style="background: linear-gradient(90deg, #002244 0%, #69BE28 100%); color: white; font-weight: bold; margin-top: 10px;">
        <span style="font-size: 1.1em;">üèÜ SUPER BOWL PROJECTION</span>
    </div>

    {% if player.position == 'QB' %}
        <div class="stat-row" style="background: #e8f5e9;">
            <span class="stat-label">üìä Projected Pass Yards:</span>
            <span class="stat-value" style="color: #2e7d32; font-size: 1.2em;">{{ player.projection.passing_yards }} yards</span>
        </div>
        <div class="stat-row" style="background: #e8f5e9;">
            <span class="stat-label">üìä Projected Pass TDs:</span>
            <span class="stat-value" style="color: #2e7d32; font-size: 1.2em;">{{ player.projection.passing_tds }}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Season Average:</span>
            <span class="stat-value">{{ player.averages.passing_yards }} yds/game</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Season Total:</span>
            <span class="stat-value">{{ player.totals.passing_yards }} yards, {{ player.totals.passing_tds }} TDs</span>
        </div>
        {% if player.sb_benchmarks.passing_yards %}
        <div class="stat-row" style="background: #fff3cd;">
            <span class="stat-label">Super Bowl QB Benchmark:</span>
            <span class="stat-value">{{ "%.0f"|format(player.sb_benchmarks.passing_yards) }} yards avg</span>
        </div>
        {% endif %}
    {% endif %}

    {% if player.position == 'RB' %}
        <div class="stat-row" style="background: #e8f5e9;">
            <span class="stat-label">üìä Projected Rush Yards:</span>
            <span class="stat-value" style="color: #2e7d32; font-size: 1.2em;">{{ player.projection.rushing_yards }} yards</span>
        </div>
        <div class="stat-row" style="background: #e8f5e9;">
            <span class="stat-label">üìä Projected Receptions:</span>
            <span class="stat-value" style="color: #2e7d32; font-size: 1.2em;">{{ player.projection.receptions }}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Season Average:</span>
            <span class="stat-value">{{ player.averages.rushing_yards }} rush yds/game, {{ player.averages.receptions }} rec/game</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Season Total:</span>
            <span class="stat-value">{{ player.totals.rushing_yards }} rush yds, {{ player.totals.rushing_tds }} rush TDs</span>
        </div>
        {% if player.sb_benchmarks.rushing_yards %}
        <div class="stat-row" style="background: #fff3cd;">
            <span class="stat-label">Super Bowl RB Benchmark:</span>
            <span class="stat-value">{{ "%.0f"|format(player.sb_benchmarks.rushing_yards) }} rush yds, {{ "%.0f"|format(player.sb_benchmarks.receptions) }} rec</span>
        </div>
        {% endif %}
    {% endif %}

    {% if player.position in ['WR', 'TE'] %}
        <div class="stat-row" style="background: #e8f5e9;">
            <span class="stat-label">üìä Projected Receptions:</span>
            <span class="stat-value" style="color: #2e7d32; font-size: 1.2em;">{{ player.projection.receptions }}</span>
        </div>
        <div class="stat-row" style="background: #e8f5e9;">
            <span class="stat-label">üìä Projected Rec Yards:</span>
            <span class="stat-value" style="color: #2e7d32; font-size: 1.2em;">{{ player.projection.receiving_yards }} yards</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Season Average:</span>
            <span class="stat-value">{{ player.averages.receptions }} rec/game, {{ player.averages.receiving_yards }} yds/game</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Season Total:</span>
            <span class="stat-value">{{ player.totals.receptions }} rec, {{ player.totals.receiving_yards }} yds, {{ player.totals.receiving_tds }} TDs</span>
        </div>
        {% if player.sb_benchmarks.receptions %}
        <div class="stat-row" style="background: #fff3cd;">
            <span class="stat-label">Super Bowl {{ player.position }} Benchmark:</span>
            <span class="stat-value">{{ "%.0f"|format(player.sb_benchmarks.receptions) }} rec, {{ "%.0f"|format(player.sb_benchmarks.receiving_yards) }} yds</span>
        </div>
        {% endif %}
    {% endif %}

    <!-- Win/Loss Splits -->
    {% if player.win_loss_splits.wins.games > 0 or player.win_loss_splits.losses.games > 0 %}
    <div class="stat-row" style="background: linear-gradient(90deg, #1e3a8a 0%, #dc2626 100%); color: white; font-weight: bold; margin-top: 10px;">
        <span style="font-size: 1.1em;">üìä WIN/LOSS SPLITS</span>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
        <!-- Wins Column -->
        <div style="background: #e0f2fe; padding: 10px; border-radius: 5px; border-left: 4px solid #1e3a8a;">
            <div style="font-weight: bold; color: #1e3a8a; margin-bottom: 5px;">‚úÖ IN WINS ({{ player.win_loss_splits.wins.games }} games)</div>
            {% if player.position == 'QB' and player.win_loss_splits.wins.passing_yards > 0 %}
            <div style="font-size: 0.9em; color: #334155;">Pass Yds: <strong>{{ player.win_loss_splits.wins.passing_yards }}</strong>/game</div>
            {% endif %}
            {% if player.position in ['QB', 'RB'] and player.win_loss_splits.wins.rushing_yards > 0 %}
            <div style="font-size: 0.9em; color: #334155;">Rush Yds: <strong>{{ player.win_loss_splits.wins.rushing_yards }}</strong>/game</div>
            {% endif %}
            {% if player.position in ['WR', 'TE', 'RB'] %}
            <div style="font-size: 0.9em; color: #334155;">Receptions: <strong>{{ player.win_loss_splits.wins.receptions }}</strong>/game</div>
            <div style="font-size: 0.9em; color: #334155;">Rec Yds: <strong>{{ player.win_loss_splits.wins.receiving_yards }}</strong>/game</div>
            {% endif %}
        </div>

        <!-- Losses Column -->
        <div style="background: #fee2e2; padding: 10px; border-radius: 5px; border-left: 4px solid #dc2626;">
            <div style="font-weight: bold; color: #dc2626; margin-bottom: 5px;">‚ùå IN LOSSES ({{ player.win_loss_splits.losses.games }} games)</div>
            {% if player.position == 'QB' and player.win_loss_splits.losses.passing_yards > 0 %}
            <div style="font-size: 0.9em; color: #334155;">Pass Yds: <strong>{{ player.win_loss_splits.losses.passing_yards }}</strong>/game</div>
            {% endif %}
            {% if player.position in ['QB', 'RB'] and player.win_loss_splits.losses.rushing_yards > 0 %}
            <div style="font-size: 0.9em; color: #334155;">Rush Yds: <strong>{{ player.win_loss_splits.losses.rushing_yards }}</strong>/game</div>
            {% endif %}
            {% if player.position in ['WR', 'TE', 'RB'] %}
            <div style="font-size: 0.9em; color: #334155;">Receptions: <strong>{{ player.win_loss_splits.losses.receptions }}</strong>/game</div>
            <div style="font-size: 0.9em; color: #334155;">Rec Yds: <strong>{{ player.win_loss_splits.losses.receiving_yards }}</strong>/game</div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div id="details-{{ player.name|replace(' ', '-') }}" class="game-details">
        <span class="close-btn" onclick="toggleGameDetails('{{ player.name }}')">&times;</span>
        <h3>{{ player.name }} - Game by Game Stats</h3>

        <!-- Bar Chart Controls -->
        <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <label style="font-weight: bold; color: #002244; display: block; margin-bottom: 10px;">
                Adjust Betting Line: <span id="line-value-{{ player.name|replace(' ', '-') }}" style="color: #69BE28;">0</span>
            </label>
            <input type="range"
                   id="line-slider-{{ player.name|replace(' ', '-') }}"
                   style="width: 100%;"
                   step="0.5">
        </div>

        <!-- Bar Chart -->
        <div id="chart-{{ player.name|replace(' ', '-') }}" style="margin: 20px 0;"></div>
        <script>
            (function() {
                // Prepare game data
                const gameData = {{ player.game_by_game|tojson }};
                const position = '{{ player.position }}';
                const playerName = '{{ player.name }}';
                const chartId = 'chart-{{ player.name|replace(' ', '-') }}';
                const sliderId = 'line-slider-{{ player.name|replace(' ', '-') }}';
                const valueDisplayId = 'line-value-{{ player.name|replace(' ', '-') }}';

                // Determine which stat to plot based on position
                let statIndex, statName, defaultLine;

                {% if player.position == 'QB' %}
                    statIndex = 5; // passing_yards
                    statName = 'Passing Yards';
                    {% if player.name in data.prop_lines %}
                        defaultLine = {{ data.prop_lines[player.name].alternate_lines.passing_yards[1].line if data.prop_lines[player.name].alternate_lines.passing_yards|length > 1 else 249.5 }};
                    {% else %}
                        defaultLine = 249.5;
                    {% endif %}
                {% elif player.position == 'RB' %}
                    statIndex = 8; // rushing_yards
                    statName = 'Rushing Yards';
                    {% if player.name in data.prop_lines %}
                        defaultLine = {{ data.prop_lines[player.name].alternate_lines.rushing_yards[0].line if data.prop_lines[player.name].alternate_lines.rushing_yards|length > 0 else 69.5 }};
                    {% else %}
                        defaultLine = 69.5;
                    {% endif %}
                {% elif player.position in ['WR', 'TE'] %}
                    statIndex = 11; // receiving_yards
                    statName = 'Receiving Yards';
                    {% if player.name in data.prop_lines %}
                        defaultLine = {{ data.prop_lines[player.name].alternate_lines.receiving_yards[1].line if data.prop_lines[player.name].alternate_lines.receiving_yards|length > 1 else 69.5 }};
                    {% else %}
                        defaultLine = 69.5;
                    {% endif %}
                {% endif %}

                // Extract values
                const weeks = gameData.map((g, i) => `Week ${i + 1}`);
                const values = gameData.map(g => g[statIndex] || 0);
                const maxValue = Math.max(...values);
                const minValue = Math.min(...values);

                // Setup slider
                const slider = document.getElementById(sliderId);
                slider.min = Math.max(0, minValue - 20);
                slider.max = maxValue + 20;
                slider.value = defaultLine;
                document.getElementById(valueDisplayId).textContent = defaultLine.toFixed(1);

                // Function to update chart
                function updateChart(bettingLine) {
                    // Calculate hit rate
                    const hitsOver = values.filter(v => v > bettingLine).length;
                    const hitRate = ((hitsOver / values.length) * 100).toFixed(1);

                    // Update bar colors
                    const colors = values.map(v => v > bettingLine ? '#22c55e' : '#dc2626');

                    // Update chart
                    const update = {
                        'marker.color': [colors],
                        y: [Array(weeks.length).fill(bettingLine)]
                    };

                    const layoutUpdate = {
                        title: {
                            text: `${statName} per Game<br><sub>Hit Rate: ${hitRate}% (${hitsOver}/${values.length} games OVER ${bettingLine.toFixed(1)})</sub>`,
                            font: { size: 16 }
                        }
                    };

                    Plotly.update(chartId, update, layoutUpdate, [0, 1]);
                }

                // Slider event
                slider.addEventListener('input', function() {
                    const newLine = parseFloat(this.value);
                    document.getElementById(valueDisplayId).textContent = newLine.toFixed(1);
                    updateChart(newLine);
                });

                // Initial chart
                const trace1 = {
                    x: weeks,
                    y: values,
                    type: 'bar',
                    name: statName,
                    marker: {
                        color: values.map(v => v > defaultLine ? '#22c55e' : '#dc2626')
                    },
                    text: values.map(v => v.toFixed(0)),
                    textposition: 'auto',
                };

                const trace2 = {
                    x: weeks,
                    y: Array(weeks.length).fill(defaultLine),
                    type: 'scatter',
                    mode: 'lines',
                    name: `Line: ${defaultLine.toFixed(1)}`,
                    line: {
                        color: '#002244',
                        width: 3,
                        dash: 'dash'
                    }
                };

                const hitsOver = values.filter(v => v > defaultLine).length;
                const hitRate = ((hitsOver / values.length) * 100).toFixed(1);

                const layout = {
                    title: {
                        text: `${statName} per Game<br><sub>Hit Rate: ${hitRate}% (${hitsOver}/${values.length} games OVER ${defaultLine.toFixed(1)})</sub>`,
                        font: { size: 16 }
                    },
                    xaxis: { title: 'Game' },
                    yaxis: { title: statName },
                    showlegend: true,
                    legend: { x: 0, y: 1.1, orientation: 'h' },
                    margin: { t: 80, b: 60 },
                    plot_bgcolor: '#f8f9fa',
                    paper_bgcolor: '#f8f9fa'
                };

                const config = {
                    responsive: true,
                    displayModeBar: false  // Disable zoom/pan toolbar
                };

                Plotly.newPlot(chartId, [trace1, trace2], layout, config);
            })();
        </script>

        <h4 style="margin-top: 30px;">Detailed Game Log</h4>
        <table>
            <tr>
                <th>Week</th>
                <th>Result</th>
                <th>Opponent</th>
                {% if player.position == 'QB' %}
                <th>Pass Yds</th>
                <th>Pass TD</th>
                <th>INT</th>
                {% endif %}
                {% if player.position in ['QB', 'RB'] %}
                <th>Rush Yds</th>
                <th>Rush TD</th>
                {% endif %}
                <th>Rec</th>
                <th>Rec Yds</th>
                <th>Rec TD</th>
            </tr>
            {% for game in player.game_by_game %}
            <tr>
                <td>{{ game[0] if game[0] else 'Playoff' }}</td>
                <td><span style="font-weight: bold; color: {% if game[2] == 'W' %}#16a34a{% else %}#dc2626{% endif %};">{{ game[2] }}</span></td>
                <td>{{ game[4] }}</td>
                {% if player.position == 'QB' %}
                <td>{{ game[5] if game[5] > 0 else '-' }}</td>
                <td>{{ game[6] if game[6] > 0 else '-' }}</td>
                <td>{{ game[7] if game[7] > 0 else '-' }}</td>
                {% endif %}
                {% if player.position in ['QB', 'RB'] %}
                <td>{{ game[8] if game[8] > 0 else '-' }}</td>
                <td>{{ game[9] if game[9] > 0 else '-' }}</td>
                {% endif %}
                <td>{{ game[10] if game[10] > 0 else '-' }}</td>
                <td>{{ game[11] if game[11] > 0 else '-' }}</td>
                <td>{{ game[12] if game[12] > 0 else '-' }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>
{% endfor %}

<div class="stat-card">
    <h2>About This Analysis</h2>
    <p>Data based on 2025 regular season performance. Super Bowl benchmarks show historical average performance for each position in Super Bowls from 2000-2024.</p>
    <p><strong>Click any player name to see game-by-game breakdown.</strong></p>
</div>

{% endblock %}
