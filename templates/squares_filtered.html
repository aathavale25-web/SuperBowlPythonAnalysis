{% extends "base.html" %}
{% set page = 'squares' %}

{% block title %}Squares Analysis - Super Bowl Analysis{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Super Bowl Squares Analysis</h1>
    <p>Quarter-by-quarter probability analysis with recency weighting (2000-2023)</p>
</div>

<style>
    .filter-buttons {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
        justify-content: center;
    }
    .filter-btn {
        padding: 12px 24px;
        background: white;
        border: 2px solid #002244;
        color: #002244;
        font-weight: bold;
        cursor: pointer;
        border-radius: 5px;
        transition: all 0.3s;
        font-size: 0.95em;
    }
    .filter-btn:hover {
        background: #f0f0f0;
    }
    .filter-btn.active {
        background: #002244;
        color: white;
    }
    .filter-info {
        text-align: center;
        margin: 15px 0;
        font-size: 0.95em;
        color: #666;
    }
    .quarter-tabs {
        display: flex;
        gap: 5px;
        margin: 20px auto;
        max-width: 700px;
        justify-content: center;
    }
    .quarter-tab {
        padding: 10px 20px;
        background: white;
        border: 2px solid #69BE28;
        color: #002244;
        font-weight: bold;
        cursor: pointer;
        border-radius: 5px;
        transition: all 0.3s;
        flex: 1;
        text-align: center;
    }
    .quarter-tab:hover {
        background: #f0f9f0;
    }
    .quarter-tab.active {
        background: #69BE28;
        color: white;
    }
    .squares-grid {
        display: grid;
        grid-template-columns: 40px repeat(10, 1fr);
        grid-template-rows: 40px repeat(10, 1fr);
        gap: 2px;
        margin: 20px auto;
        max-width: 700px;
        background: #002244;
        padding: 2px;
        border-radius: 8px;
    }
    .grid-cell {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.85em;
        border-radius: 4px;
        transition: all 0.2s;
    }
    .grid-header {
        background: #002244;
        color: white;
        font-weight: bold;
    }
    .grid-data {
        cursor: pointer;
        position: relative;
    }
    .grid-data:hover {
        transform: scale(1.1);
        z-index: 10;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .grid-label {
        background: #69BE28;
        color: white;
        font-size: 0.9em;
    }
    .probability-legend {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin: 20px 0;
        font-size: 0.9em;
        flex-wrap: wrap;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .legend-box {
        width: 30px;
        height: 20px;
        border-radius: 3px;
    }
    .top-squares {
        max-width: 700px;
        margin: 30px auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .top-squares h3 {
        color: #002244;
        margin-bottom: 15px;
    }
    .square-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    .square-item:last-child {
        border-bottom: none;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        overflow: auto;
    }
    .modal-content {
        background-color: white;
        margin: 50px auto;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 700px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #002244;
    }
    .modal-header h2 {
        color: #002244;
        margin: 0;
    }
    .close-modal {
        font-size: 2em;
        font-weight: bold;
        color: #666;
        cursor: pointer;
        line-height: 1;
    }
    .close-modal:hover {
        color: #000;
    }
    .game-item {
        padding: 15px;
        margin: 10px 0;
        background: #f8f9fa;
        border-left: 4px solid #69BE28;
        border-radius: 4px;
    }
    .game-type-badge {
        display: inline-block;
        background: #002244;
        color: white;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 0.75em;
        font-weight: bold;
        margin-right: 10px;
    }
    .game-score {
        font-size: 1.1em;
        font-weight: bold;
        color: #002244;
        margin: 5px 0;
    }
    .game-meta {
        font-size: 0.9em;
        color: #666;
    }
</style>

<!-- Game Type Filters -->
<div class="filter-buttons">
    <button class="filter-btn active" onclick="changeFilter('all')">All Games (74)</button>
    <button class="filter-btn" onclick="changeFilter('superbowl')">Super Bowl Only (24)</button>
    <button class="filter-btn" onclick="changeFilter('championship')">Championship Games (50)</button>
    <button class="filter-btn" onclick="changeFilter('afc_championship')">AFC Championship (25)</button>
    <button class="filter-btn" onclick="changeFilter('nfc_championship')">NFC Championship (25)</button>
</div>

<div class="filter-info" id="filter-info">
    Showing: All Games (74 games, 132 weighted samples)
</div>

<!-- Quarter Tabs -->
<div class="quarter-tabs">
    <button class="quarter-tab active" onclick="changeQuarter('q1')">Q1</button>
    <button class="quarter-tab" onclick="changeQuarter('q2')">Q2</button>
    <button class="quarter-tab" onclick="changeQuarter('q3')">Q3</button>
    <button class="quarter-tab" onclick="changeQuarter('q4')">Q4</button>
    <button class="quarter-tab" onclick="changeQuarter('final')">Final</button>
</div>

<!-- Conditional Probability Calculator -->
<div style="max-width: 700px; margin: 20px auto; padding: 20px; background: linear-gradient(135deg, #002244 0%, #69BE28 100%); border-radius: 8px; color: white;">
    <h3 style="margin-top: 0; color: white;">ðŸŽ¯ Live Game Calculator</h3>
    <p style="font-size: 0.9em; opacity: 0.9; margin-bottom: 15px;">Enter the current quarter's final score to see how it affects the next quarter's probabilities</p>

    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
        <div>
            <label style="display: block; font-size: 0.9em; margin-bottom: 5px;">Winner Score:</label>
            <input type="number" id="winner-score" min="0" max="99" placeholder="e.g., 7"
                   style="width: 100%; padding: 10px; border: none; border-radius: 4px; font-size: 1em;">
        </div>
        <div>
            <label style="display: block; font-size: 0.9em; margin-bottom: 5px;">Loser Score:</label>
            <input type="number" id="loser-score" min="0" max="99" placeholder="e.g., 3"
                   style="width: 100%; padding: 10px; border: none; border-radius: 4px; font-size: 1em;">
        </div>
        <div style="display: flex; gap: 5px;">
            <button onclick="calculateConditional()"
                    style="padding: 10px 20px; background: white; color: #002244; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                Calculate
            </button>
            <button onclick="resetConditional()"
                    style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 4px; font-weight: bold; cursor: pointer;">
                Reset
            </button>
        </div>
    </div>

    <div id="conditional-info" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 0.9em; display: none;">
    </div>
</div>

<!-- Probability Legend -->
<div class="probability-legend">
    <div class="legend-item">
        <div class="legend-box" style="background: #ef4444;"></div>
        <span>0-2%</span>
    </div>
    <div class="legend-item">
        <div class="legend-box" style="background: #f97316;"></div>
        <span>2-4%</span>
    </div>
    <div class="legend-item">
        <div class="legend-box" style="background: #eab308;"></div>
        <span>4-6%</span>
    </div>
    <div class="legend-item">
        <div class="legend-box" style="background: #84cc16;"></div>
        <span>6-8%</span>
    </div>
    <div class="legend-item">
        <div class="legend-box" style="background: #22c55e;"></div>
        <span>8%+</span>
    </div>
</div>

<!-- Squares Grid -->
<div id="squares-container"></div>

<!-- Top 10 Squares -->
<div class="top-squares" id="top-squares"></div>

<!-- Game Details Modal -->
<div id="gameModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title"></h2>
            <span class="close-modal" onclick="closeModal()">&times;</span>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<script>
// Load the filtered squares data
const squaresData = {{ data.squares_data|tojson|safe }};
const progressionData = {{ data.progression_data|tojson|safe }};

let currentFilter = 'all';
let currentQuarter = 'q1';
let conditionalMode = false;
let conditionalData = null;

function getColor(probability) {
    const pct = probability * 100;
    if (pct >= 8) return '#22c55e';
    if (pct >= 6) return '#84cc16';
    if (pct >= 4) return '#eab308';
    if (pct >= 2) return '#f97316';
    return '#ef4444';
}

function renderGrid() {
    const data = squaresData[currentFilter];
    if (!data) return;

    // Use conditional data if in conditional mode, otherwise use regular data
    const matrix = conditionalMode && conditionalData ? conditionalData.matrix : data.matrices[currentQuarter];

    let html = '<div class="squares-grid">';

    // Top-left corner
    html += '<div class="grid-cell grid-header"></div>';

    // Top row (loser digits)
    for (let i = 0; i < 10; i++) {
        html += `<div class="grid-cell grid-label">${i}</div>`;
    }

    // Data rows
    for (let row = 0; row < 10; row++) {
        // Row label (winner digit)
        html += `<div class="grid-cell grid-label">${row}</div>`;

        // Data cells
        for (let col = 0; col < 10; col++) {
            const prob = matrix[row][col];
            const color = getColor(prob);
            const pct = (prob * 100).toFixed(1);
            html += `<div class="grid-cell grid-data"
                         style="background: ${color}; color: white;"
                         title="${row}-${col}: ${pct}% - Click to see games"
                         onclick="showGameDetails(${row}, ${col}, ${pct})">
                        ${pct}%
                    </div>`;
        }
    }

    html += '</div>';

    // Add axis labels
    html += '<div style="text-align: center; margin: 10px 0; color: #666;">';
    html += '<div><strong>Horizontal (Top):</strong> Loser\'s Last Digit</div>';
    html += '<div><strong>Vertical (Left):</strong> Winner\'s Last Digit</div>';
    html += '</div>';

    document.getElementById('squares-container').innerHTML = html;
}

function renderTopSquares() {
    const data = squaresData[currentFilter];
    if (!data) return;

    const ranked = data.ranked[currentQuarter];

    let html = '<h3>Top 10 Squares for ' + currentQuarter.toUpperCase() + '</h3>';

    for (let i = 0; i < Math.min(10, ranked.length); i++) {
        const square = ranked[i];
        const pct = (square.probability * 100).toFixed(2);
        html += `<div class="square-item">
                    <span><strong>${i + 1}.</strong> Winner: ${square.winner}, Loser: ${square.loser}</span>
                    <span style="color: #69BE28; font-weight: bold;">${pct}%</span>
                 </div>`;
    }

    document.getElementById('top-squares').innerHTML = html;
}

function changeFilter(filter) {
    currentFilter = filter;

    // Update button states
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // Update info
    const data = squaresData[filter];
    document.getElementById('filter-info').innerHTML =
        `Showing: ${data.name} (${data.game_count} games, ${data.sample_count} weighted samples)`;

    renderGrid();
    renderTopSquares();
}

function changeQuarter(quarter) {
    currentQuarter = quarter;

    // Update button states
    document.querySelectorAll('.quarter-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    renderGrid();
    renderTopSquares();
}

function showGameDetails(winnerDigit, loserDigit, probability) {
    const data = squaresData[currentFilter];
    if (!data) return;

    const gameDetails = data.game_details[currentQuarter];
    const key = `${winnerDigit}-${loserDigit}`;
    const games = gameDetails[key] || [];

    // Set modal title
    document.getElementById('modal-title').innerHTML =
        `Square ${winnerDigit}-${loserDigit} (${probability}% probability)`;

    // Build modal body
    let html = '';

    if (games.length === 0) {
        html = '<p style="text-align: center; color: #666; padding: 20px;">No games found for this square combination.</p>';
    } else {
        html += `<p style="margin-bottom: 15px; color: #666;">
                    <strong>${games.length} game${games.length !== 1 ? 's' : ''}</strong> with this score combination in ${currentQuarter.toUpperCase()}
                 </p>`;

        // Sort by year descending
        games.sort((a, b) => b.year - a.year);

        for (const game of games) {
            const gameTypeName = game.game_type === 'superbowl' ? 'Super Bowl' :
                               game.game_type === 'afc_championship' ? 'AFC Championship' :
                               game.game_type === 'nfc_championship' ? 'NFC Championship' : game.game_type;

            html += `<div class="game-item">
                        <div>
                            <span class="game-type-badge">${gameTypeName}</span>
                            <span class="game-meta">${game.year}</span>
                        </div>
                        <div class="game-score">
                            ${game.winner} ${game.winner_score} - ${game.loser} ${game.loser_score}
                        </div>
                        <div class="game-meta">
                            Final Score: ${game.winner} ${game.winner_final} - ${game.loser} ${game.loser_final}
                        </div>
                     </div>`;
        }
    }

    document.getElementById('modal-body').innerHTML = html;

    // Show modal
    document.getElementById('gameModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('gameModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('gameModal');
    if (event.target == modal) {
        closeModal();
    }
}

function calculateConditional() {
    const winnerScore = parseInt(document.getElementById('winner-score').value);
    const loserScore = parseInt(document.getElementById('loser-score').value);

    if (isNaN(winnerScore) || isNaN(loserScore)) {
        alert('Please enter valid scores for both teams');
        return;
    }

    // Determine current quarter and next quarter
    const quarterOrder = ['q1', 'q2', 'q3', 'q4', 'final'];
    const currentIndex = quarterOrder.indexOf(currentQuarter);

    if (currentIndex === quarterOrder.length - 1) {
        alert('Cannot calculate conditional probability for Final quarter (no next quarter)');
        return;
    }

    const prevQuarter = currentQuarter;
    const nextQuarter = quarterOrder[currentIndex + 1];
    const progressionKey = `${prevQuarter}_to_${nextQuarter}`;

    // Get progression data for current filter
    const filterProgressions = progressionData[currentFilter];
    if (!filterProgressions || !filterProgressions.progressions) {
        alert('Progression data not available for this filter');
        return;
    }

    const progressions = filterProgressions.progressions[progressionKey];
    if (!progressions) {
        alert('No progression data available for this quarter transition');
        return;
    }

    const prevKey = `${winnerScore % 10}-${loserScore % 10}`;
    const conditionalProbs = progressions[prevKey];

    if (!conditionalProbs || Object.keys(conditionalProbs).length === 0) {
        document.getElementById('conditional-info').style.display = 'block';
        document.getElementById('conditional-info').innerHTML =
            `âŒ No historical games found where ${prevQuarter.toUpperCase()} ended with last digits ${winnerScore % 10}-${loserScore % 10}`;
        return;
    }

    // Build conditional probability matrix
    const conditionalMatrix = Array(10).fill(0).map(() => Array(10).fill(0));

    let totalGames = 0;
    for (const nextKey in conditionalProbs) {
        totalGames += conditionalProbs[nextKey].count;
    }

    for (const nextKey in conditionalProbs) {
        const [winner, loser] = nextKey.split('-').map(Number);
        conditionalMatrix[winner][loser] = conditionalProbs[nextKey].probability;
    }

    // Store conditional data and switch to conditional mode
    conditionalMode = true;
    conditionalData = {
        matrix: conditionalMatrix,
        prevQuarter: prevQuarter,
        prevScore: `${winnerScore}-${loserScore}`,
        nextQuarter: nextQuarter,
        totalGames: totalGames
    };

    // Switch to next quarter
    currentQuarter = nextQuarter;
    document.querySelectorAll('.quarter-tab').forEach((btn, idx) => {
        btn.classList.remove('active');
        if (idx === currentIndex + 1) btn.classList.add('active');
    });

    // Show info
    document.getElementById('conditional-info').style.display = 'block';
    document.getElementById('conditional-info').innerHTML =
        `âœ… Conditional probabilities for ${nextQuarter.toUpperCase()} given ${prevQuarter.toUpperCase()} ended ${winnerScore}-${loserScore}<br>
        <small>Based on ${totalGames} historical game(s) with this ${prevQuarter.toUpperCase()} score pattern</small>`;

    renderGrid();
    renderTopSquares();
}

function resetConditional() {
    conditionalMode = false;
    conditionalData = null;
    document.getElementById('winner-score').value = '';
    document.getElementById('loser-score').value = '';
    document.getElementById('conditional-info').style.display = 'none';

    renderGrid();
    renderTopSquares();
}

// Initial render
renderGrid();
renderTopSquares();
</script>

<div class="stat-card" style="margin-top: 30px; max-width: 900px; margin-left: auto; margin-right: auto;">
    <h2>About This Analysis</h2>
    <p><strong>Dataset:</strong> 74 championship games from 2000-2026 (24 Super Bowls, 25 AFC Championships, 25 NFC Championships)</p>
    <p><strong>Methodology:</strong> Probabilities calculated from actual score combination frequencies, not independence assumptions. Recency weighting applied (3x last 5 years, 2x last 15 years, 1x older).</p>
    <p><strong>How to Use:</strong></p>
    <ul>
        <li>Select a game type filter to see probabilities for specific types of games</li>
        <li>Select a quarter to see how probabilities change throughout the game</li>
        <li>Hover over squares to see exact probabilities</li>
        <li>Green squares are best, red squares are worst</li>
    </ul>
</div>

{% endblock %}
