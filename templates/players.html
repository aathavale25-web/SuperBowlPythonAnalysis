{% extends "base.html" %}
{% set page = 'players' %}

{% block title %}Player Props - Super Bowl Analysis{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Player Prop Analysis</h1>
    <p>Season statistics, betting line hit rates, and trend analysis</p>
</div>

{% if data.players.summaries %}
    {% for player in data.players.summaries %}
    <div class="card">
        <div class="card-header">
            <h2>{{ player.player_name }} ({{ player.position }})</h2>
        </div>

        <!-- Season Stats -->
        <h3>Season Statistics</h3>
        <table>
            <thead>
                <tr>
                    <th>Stat</th>
                    <th>Avg</th>
                    <th>Median</th>
                    <th>High</th>
                    <th>Low</th>
                </tr>
            </thead>
            <tbody>
                {% for key, value in player.stats.items()|sort %}
                    {% if key.startswith('avg_') %}
                        {% set stat_name = key.replace('avg_', '').replace('_', ' ')|title %}
                        {% set median_key = 'median_' + key.replace('avg_', '') %}
                        {% set high_key = 'high_' + key.replace('avg_', '') %}
                        {% set low_key = 'low_' + key.replace('avg_', '') %}
                        <tr>
                            <td>{{ stat_name }}</td>
                            <td>{{ "%.1f"|format(value) }}</td>
                            <td>{{ "%.1f"|format(player.stats[median_key]) }}</td>
                            <td>{{ "%.0f"|format(player.stats[high_key]) }}</td>
                            <td>{{ "%.0f"|format(player.stats[low_key]) }}</td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>

        <!-- Hit Rates -->
        <h3 style="margin-top: 2rem;">Betting Line Hit Rates</h3>
        {% for stat_column, hit_rates in player.hit_rates.items() %}
            <h4 style="margin-top: 1rem;">{{ stat_column|replace('_', ' ')|title }}</h4>
            <table>
                <thead>
                    <tr>
                        <th>Line</th>
                        <th>Over %</th>
                        <th>Over Count</th>
                        <th>Under %</th>
                        <th>Under Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for line in hit_rates.keys()|sort %}
                        {% set data_row = hit_rates[line] %}
                        <tr>
                            <td>{{ line }}</td>
                            <td class="{% if data_row.hit_rate_over >= 0.65 %}stat-good{% elif data_row.hit_rate_over >= 0.50 %}stat-moderate{% endif %}">
                                {{ "%.1f%%"|format(data_row.hit_rate_over * 100) }}
                            </td>
                            <td>{{ data_row.over }}/{{ data_row.over + data_row.under }}</td>
                            <td>{{ "%.1f%%"|format(data_row.hit_rate_under * 100) }}</td>
                            <td>{{ data_row.under }}/{{ data_row.over + data_row.under }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endfor %}

        <!-- Super Bowl Benchmarks -->
        {% if player.sb_benchmarks %}
            <h3 style="margin-top: 2rem;">Super Bowl Benchmarks</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Historical {{ player.position }} performance in Super Bowls
            </p>
            <table class="sb-benchmark-table">
                <thead>
                    <tr>
                        <th>Stat</th>
                        <th>SB Avg</th>
                        <th>Season Avg</th>
                        <th>vs SB Avg</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat, benchmark in player.sb_benchmarks.items() %}
                        {% if stat.startswith('avg_') %}
                            {% set stat_name = stat.replace('avg_', '').replace('_', ' ')|title %}
                            {% set season_avg = player.stats[stat] %}
                            {% set diff = season_avg - benchmark %}
                            {% set diff_pct = (diff / benchmark * 100) if benchmark > 0 else 0 %}
                            <tr>
                                <td>{{ stat_name }}</td>
                                <td>{{ "%.1f"|format(benchmark) }}</td>
                                <td>{{ "%.1f"|format(season_avg) }}</td>
                                <td class="{% if diff > 0 %}positive{% elif diff < 0 %}negative{% else %}neutral{% endif %}">
                                    {{ "%+.1f"|format(diff) }} ({{ "%+.0f%%"|format(diff_pct) }})
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}

        <!-- Best Bets -->
        {% if player.best_bets %}
            <h3 style="margin-top: 2rem;">Best Bets (>65% Hit Rate)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Stat</th>
                        <th>Line</th>
                        <th>Hit Rate</th>
                        <th>Count</th>
                        {% if player.sb_benchmarks %}<th>SB Validated</th>{% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for bet in player.best_bets|sort(attribute='hit_rate', reverse=True) %}
                    <tr class="{% if bet.sb_validated %}strong-bet{% endif %}">
                        <td>{{ bet.stat|replace('_', ' ')|title }}</td>
                        <td>Over {{ bet.line }}</td>
                        <td class="stat-good">{{ "%.1f%%"|format(bet.hit_rate * 100) }}</td>
                        <td>{{ bet.over_count }}/{{ bet.over_count + bet.under_count }}</td>
                        {% if player.sb_benchmarks %}
                            <td>
                                {% if bet.sb_validated %}
                                    <span class="validated">Yes</span>
                                {% else %}
                                    <span style="color: var(--text-secondary);">No</span>
                                {% endif %}
                            </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Combined Predictions -->
            {% if player.sb_benchmarks %}
                <div class="combined-prediction">
                    <h4>Combined Analysis (Season + SB History)</h4>
                    {% set validated_bets = player.best_bets|selectattr('sb_validated', 'equalto', true)|list %}
                    {% if validated_bets %}
                        <p style="color: var(--accent-green); margin: 0.5rem 0;">
                            <strong>{{ validated_bets|length }}</strong> bet(s) validated by Super Bowl history
                        </p>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">
                            These props show strong hit rates in both regular season and Super Bowl games
                        </p>
                    {% else %}
                        <p style="color: var(--text-secondary);">
                            No bets validated by Super Bowl history. Consider player's regular season trends but note different SB performance patterns.
                        </p>
                    {% endif %}
                </div>
            {% endif %}
        {% endif %}

        <!-- Trends -->
        {% if player.trends %}
            <h3 style="margin-top: 2rem;">Last 5 Games Trend</h3>
            <table>
                <thead>
                    <tr>
                        <th>Stat</th>
                        <th>Direction</th>
                        <th>Last 5 Avg</th>
                        <th>Previous 5 Avg</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat, trend in player.trends.items() %}
                        {% if trend.direction != 'insufficient_data' %}
                        <tr>
                            <td>{{ stat|replace('_', ' ')|title }}</td>
                            <td>
                                {% if trend.direction == 'improving' %}
                                    üìà Improving
                                {% elif trend.direction == 'declining' %}
                                    üìâ Declining
                                {% else %}
                                    ‚û°Ô∏è Stable
                                {% endif %}
                            </td>
                            <td>{{ "%.1f"|format(trend.last_n_avg) }}</td>
                            <td>{{ "%.1f"|format(trend.previous_n_avg) }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>
    {% endfor %}
{% else %}
    <div class="card">
        <p>‚ö†Ô∏è No player data available. Run player analysis or regenerate.</p>
    </div>
{% endif %}
{% endblock %}
